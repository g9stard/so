<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>검은색 테두리 추적기</title>
    <script src="https://docs.opencv.org/4.x/opencv.js" async></script>
    <style>
        #canvas {
            display: block;
        }
        video {
            display: none; /* 비디오 요소 숨김 */
        }
    </style>
</head>
<body>
    <video id="video" controls muted autoplay loop playsinline></video>
    <canvas id="canvas"></canvas>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');

        // 카메라 접근
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.play();
                detectBlackBorders();
            })
            .catch(err => {
                console.error("카메라 접근 오류:", err);
            });

        function detectBlackBorders() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            let src = cv.imread(canvas);
            let dst = new cv.Mat();
            let gray = new cv.Mat();
            let edges = new cv.Mat();

            // 그레이스케일로 변환
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            // 엣지 검출
            cv.Canny(gray, edges, 50, 100);

            // 윤곽선 찾기
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(edges, contours, hierarchy, cv.RETR_CCOMP, cv.CHAIN_APPROX_SIMPLE);

            // 검은색 테두리 탐지 및 표시
            for (let i = 0; i < contours.size(); i++) {
                let contour = contours.get(i);
                let color = new cv.Scalar(255, 0, 0, 255); // 빨간색
                cv.drawContours(src, contours, i, color, 1, cv.LINE_8, hierarchy, 100);

                // 면적이 작은 윤곽선은 무시
                if (cv.contourArea(contour) < 1000) continue;

                // 사각형의 경계 상자 가져오기
                let rect = cv.boundingRect(contour);
                cv.rectangle(src, rect, color, 2);
            }

            // 결과 표시
            cv.imshow(canvas, src);
            // 메모리 해제
            src.delete(); gray.delete(); edges.delete(); dst.delete(); hierarchy.delete(); contours.delete();
            
            requestAnimationFrame(detectBlackBorders); // 계속해서 추적
        }
    </script>
</body>
</html>
